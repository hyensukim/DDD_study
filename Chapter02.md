# 🎆 아키텍처 개요

> 핵심 학습 목표

✅ 아키텍처

✅ DIP

✅ 도메인 영역의 주요 구성 요소

✅ 인프라스트럭처

✅ 모듈

## 2.1 네 개의 영역

아키텍처를 설계할 때 출현하는 전형적인 4가지 영역 - 표현, 응용, 도메인, 인프라스트럭처

> 표현 영역

- 사용자 요청을 응용영역에 전달 후 응용영역에 처리한 결과를 사용자에게 보여준다.
- 스프링 MVC 프레임워크 는 표현 영역을 위한 기술이다.
- HTTP 요청 시 전달된 데이터를 응용영역에서 사용할 데이터로 변환 후 전달해준다.

> 응용 영역

- 시스템이 사용자에게 제공해야 할 기능 구현.
- 기능 구현을 위해 도메인 모델을 사용
- [❓로직을 직접 구현하지 않고, 도메인 영역에 로직 수행을 위임한다.]()

> 도메인 영역

- 도메인 모델을 구현.
- 도메인 핵심 로직을 구현.

> 인프라스트럭처 영역

- 도메인, 응용, 표현 영역은 구현 기술을 사용한 코드를 직접 만들지 않고, 인프라스트럭처 영역에서 제공하는 기능을 사용하여 필요한 기능을 개발한다.
- 구현 기술
  - RDBMS 연동
  - 메시지 큐 메시지 전송/수신 기능
  - 몽고 DB, 레디스 와의 데이터 연동 처리
  - SMTP 서버

## 2.2 계층구조의 아키텍처

- 계층구조

```
표현 ➡️ 응용 ➡️ 도메인 ➡️ 인프라스트럭쳐
```

계층구조는 특성상 상위 계층에서 하위 계층으로의 의존만 존재하고 반대는 성립하지 않는다.

하지만, 편의를 위해 계층구조를 유연하게 조정하기도 하는데, 응용계층이 도메인이 아닌 인프라스트럭처 계층에 의존하는 경우이다.

```
응용 	➡️ 도메인(엔티티) ➡️ 인프라스트럭처
응용	➡️	인프라스트럭처

```

여기서 주목해야 할 점은 표현, 응용, 도메인 계층이 인프라스트럭처 계층에 종속된다는 점이다.

종속될 경우, 2가지 문제가 발생하게 된다.

- 테스트의 어려움
- 기능확장의 어려움

> 테스트의 어려움

인프라스트럭처 계층의 구현이 완변해야만 상위 계층의 기능 Test가 가능하다.

> 기능확장의 어려움

인프라스트럭처 계층에 의존 정도 너무 높기 때문에 수정 시 상위 계층의 코드에 많은 부분이 수정된다.

이러한 문제점을 해결하기 위한 것이 **DIP** 이다.

> ✅ 아키텍처

- 일반 계층 구조 '표현 --> 응용 --> 도메인 --> 인프라스트럭처' 구조이다.

## 2.3 DIP

인스트럭처 계층의 저수준 모듈과 응용 계층의 고수준 모듈이 있다.

고수준 모듈은 의미있는 단일 기능을 제공하며, 저수준 모듈은 이를 구성하는 내부 기능들을 의미한다.

즉, 고수준 모듈이 저수준 모듈에 의존하는 방식이 일반적이다.

하지만, 이는 테스트의 어려움과 기능 확장에 문제점을 갖는다.

이를 위해 DIP 라는 개념이 도입되었는데, DIP란 무엇인가?

DIP는 제어의 역전 원칙으로써, Dependency Inversion Principle 을 의미한다.

즉, 저수준 모듈이 고수준 모듈에 의존하는 것을 말한다.

하지만, 상식적으로 저수준 계층에 의존해야 기능이 완성되는 고수준 모듈에서 어떻게 의존을 역전한다는 건지 이해 되지 않는다.

이는 `인터페이스` 를 통해 추상화 모듈을 추가해줌으로써 가능하게 해준다.

```
기존 의존 관계
	고수준 모듈 --> 저수준 모듈

DIP 가 적용된 관계
	고수준 모듈 --> 인터페이스 ◁-- 저수준 모듈

```

이처럼 인터페이스로 추상화 계층을 추가해주면, 위 2가지 문제점들을 해결할 수 있다.

1. 구현 기술 교체 문제

저수준 모듈이 추상화 계층을 구현하고, 고수준 모듈에서 인터페이스에 의존을 하기 때문에 아래와 같은 코드로 작성하는 것이 가능하다.

```
인터페이스 변수명1 = new 저수준();


고수준 변수명2 = new 고수준(인터페이스 타입 변수명1);

```

위 코드는 기능이 수정될 경우  `new 저수준()` 코드만 바꿔주면, 고수준 모듈의 로직이 변경되기 때문에 고수준 모듈에서 수정할 부분이 없어진다.

2. 고수준 모듈 기능 테스트 문제

기존에는 고수준 모듈이 저수준 모듈에 직접 의존하여 저수준 모듈이 생성되기 전까지 테스트가 불가하였다.

하지만, DIP 적용 후 인터페이스 타입에 이를 구현한 대체 객체를 생성하여 테스트가 가능하므로, 2번 문제도 해결된다.

> ❓대체 객체(Mock)

### 2.3.1 DIP 주의사항

DIP를 적용한 목적에 집중하면, 함정으로 부터 무사할 수 있다.

DIP는 고수준 모듈이 저수준에 의존하는 것을 막기 위한 개념이다.

이를 지키기 위해서는 추상화의 대상이 고수준 모듈이어야 한다.

### 2.3.2 DIP와 아키텍처

일반 계층 구조와는 반대로 인프라스트럭처 계층이 응용과 도메인 계층에 의존하여 위쪽에 위치하게 된다.

물론 DIP를 통해 얻는 이점이 있지만, 그렇지 않은 경우나 추상화가 잘 떠오르지 않은 경우에는 어느정도 적용 범위를 검토할 필요가 있다.

> ✅DIP

- 의존 역전의 원칙
- 고수준 모듈과 저수준 모듈 사이에 추상화 계층을 추가하여, 고수준이 저수준에 의존하는 정도를 줄여주는 개념.

## 2.4 도메인 영역의 주요 구성요소

도메인 영역의 주요 구성 요소는 엔티티, 밸류, 에그리거트, 리포지토리, 도메인서비스 로 구성되어 있다.

##### 엔티티

- 고유 식별자
- 고유 개념
- 도메인 모델의 데이터를 포함


##### 밸류

- 고유 식별자 X
- 주로 개념적으로 하나의 값을 의미
- ex) 주소, 금액, 주문번호 ...


##### 에그리거트

- 연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것


##### 리포지토리

- 도메인 모델의 영속성 처리


##### 도메인 서비스

- 특정 엔티티에 속하지 않은 도메인 로직을 제공


### 2.4.1 엔티티와 밸류

DB 내 관계형 엔티티  != 도메인 모델 엔티티

차이점

1. 도메인 모델 엔티티는 데이터 + 도메인 기능을 제공

ex) 주문 엔티티 -> 주문 데이터 + 배송지 주소 변경과 같은 로직을 함께 제공

2. 두 개 이상의 데이터가 개념적으로 하나인 경우 밸류 타입으로 표현이 가능.


### 2.4.2 에그리거트

도메인 규모가 커짐에 따라 도메인 모델이 커지고, 엔티티와 밸류의 갯수가 많아지게 된다.

도메인의 전체 구조를 한 눈에 확인하기 위한 개념으로, 관련 객체를 묶어서 객체 군집 단위로 모델을 바라본다.

에그리거트에 `루트 엔티티` 라는 개념이 나오는데, 하위 엔티티나 밸류를 가지고 에그리거트가 구현해야 하는 기능을 제공한다.

즉, 에그리거트를 사용하는 코드는 에그리거트 루트가 제공하는 기능을 실행하고, 에그리거트 루트를 통해 간접적으로 에그리거트 내 엔티티, 밸류에 접근한다.

이를 통해, 에그리거트 내부 구현을 캡슐화 할 수 있다.

❓ 에그리거트의 루트 엔티티와 엔티티 간의 차이점, 에그리거트의 개념이 무엇일까...?


### 2.4.3 리포지토리

도메인 객체의 데이터를 유지하기 위해서는 물리적 저장소(db)에 저장해야 한다.리포지토리는 도메인 객체를 영속화 하는데 필요한 기능을 추상화한 요소이다.(고수준)

이를 구현한 클래스는 저수준 모듈로 인프라스트럭처에 속한다.(저수준)

응용서비스는 의존 주입을 통해서 리포지토리 구현 객체에 접근한다.(응용서비스 -> 리포지토리)

일반적으로 필요한 도메인 객체를 구하거나 저장할 때 리포지토리 사용하고,

트랜잭션 고나리에 리포지토리 구현 기술이 사용된다.


## 2.5 요청 처리 흐름

![img](https://github.com/hyensukim/DDD_study/blob/main/image/%EC%9A%94%EC%B2%AD%20%EC%B2%98%EB%A6%AC%20%ED%9D%90%EB%A6%84.png?raw=true)


## 2.6 인프라스트럭처 개요

DIP를 사용하여 인프라스트럭처 영역과 도메인 영역 사이에 인터페이스를 추가해주는 것은 유연하고 테스트가 용이한 코드를 만들어준다.

하지만 무조건 인프라스트럭처에 대한 의존을 없앨 필요는 없다.

예를 들어, 스프링을 사용하는 경우 XML 매핑 설정을 이용할 때보다 어노테이션을 사용하여 구현시 편리하도록 인프라스트럭처에 대한 의존을 도메인에 주입한다.


## 2.7 모듈 구성

✅ 모듈(패키지 구성 규칙)

![img](https://github.com/hyensukim/DDD_study/blob/main/image/%EB%AA%A8%EB%93%88%20%EA%B5%AC%EC%84%B11.jpg?raw=true)

![img](https://github.com/hyensukim/DDD_study/blob/main/image/%EB%AA%A8%EB%93%88%EA%B5%AC%EC%84%B12.jpg?raw=true)
